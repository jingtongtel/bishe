<?xml version="1.0" encoding="UTF-8" ?>   
<!DOCTYPE mapper   
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- mybatis操作student对象的配置文件，与mapper接口对应 -->
<mapper namespace="com.boco.human.v01.mapper.PopulationMapper">

	<!-- ************************/population/region**************************** -->
	
	
	<!-- 通过粒度字段判断查询哪个表 -->
	<sql id="queryRegionTable">
		<choose>
	
	       <when test='timeSize.equals("2")'>
	              DM_PEOPLE_D
	       </when>
	       <when test='timeSize.equals("3")'>
	              DM_PEOPLE_W
	       </when>
	       <when test='timeSize.equals("4")'>
	              DM_PEOPLE_M
	       </when>
	       <when test='timeSize.equals("5")'>
	              DM_PEOPLE_Q
	       </when>
	      
	       <otherwise>
	              DM_PEOPLE_D
	       </otherwise>
		</choose>
	</sql>
	

	
	<!-- 拼接截取时用的字段 -->
	<sql id="queryRegionCodeLength">
		<choose>
			<when test='regionLevelLength!= null '>
	          SUBSTR(q.REGUCODE,0,   ${regionLevelLength})
	       </when>
	       <otherwise>
	        SUBSTR(q.REGUCODE,0,  instr(q.REGUCODE,'-',1,1)-1) 
	              
	       </otherwise>
		</choose>
	</sql>
	
	
	
	<select id="queryRegion" resultType="hashMap">
SELECT
	x.userSum user_sum,
	x.object_id,
	f.REGION_NAME region_name,
	x.density density,
	x.date_full
FROM
	(
		SELECT
	       
			<include refid="queryRegionCodeLength"></include> zongjie,
	        REGCODE object_id,
			SUM(USER_SUM) userSum,
			round(USER_SUM /REGAREA,2) density,
			DATE_FULL date_full
			
			
		FROM
			<include refid="queryRegionTable"></include>  q
		<where> 
		<if test="distributionId!= null">
				AND	q.DISTRIBUTE_ID LIKE CONCAT(#{distributionId},'%')  
		</if>

		<if test="regionType!=null and !regionType.equals('')">
		AND q.REGTYPE_ID = #{regionType}
		</if>
		<if test="userType!=null and !userType.equals('')">
		AND q.USER_TYPE_ID = #{userType}  
		</if>
		
 	 	<if test="subRegionCode != null and subRegionCode.size() > 0">
		AND
		<foreach item="item" index="index" collection="subRegionCode" open="(" separator="OR" close=")">   
            q.REGUCODE like CONCAT(#{item},'%')   
 		</foreach>  
		</if>
		<if test="timeVals!=null and timeVals.size() > 0">
 		AND 
			 q.DATE_FULL  IN
			<foreach item="item" index="index" collection="timeVals" open="(" separator="," close=")">
				#{item}
			</foreach>
			</if>
			</where>
	 	GROUP BY
       
		<include refid="queryRegionCodeLength"></include> ,
		
		round(USER_SUM / REGAREA, 2),
		REGCODE,
		DATE_FULL
		
		
		) x
		INNER JOIN dim_keyregion f ON x.zongjie = f.REGION_UCODE
		order by x.userSum DESC
	</select>
	
	<select id="queryRegionDensity" resultType="hashMap">
SELECT
	x.userSum user_sum,
	x.object_id,
	f.REGION_NAME region_name,
	x.density density
FROM
	(
		SELECT
	       
			<include refid="queryRegionCodeLength"></include> zongjie,
	        REGCODE object_id,
			SUM(USER_SUM) userSum,
			round(USER_SUM /REGAREA,2) density
			
			
		FROM
			<include refid="queryRegionTable"></include>  q
		<where> 
		<if test="distributionId!= null">
				AND	q.DISTRIBUTE_ID LIKE CONCAT(#{distributionId},'%')  
		</if>

		<if test="regionType!=null and !regionType.equals('')">
		AND q.REGTYPE_ID = #{regionType}
		</if>
		<if test="userType!=null and !userType.equals('')">
		AND q.USER_TYPE_ID = #{userType}  
		</if>
		
 	 	<if test="subRegionCode != null and subRegionCode.size() > 0">
		AND
		<foreach item="item" index="index" collection="subRegionCode" open="(" separator="OR" close=")">   
            q.REGUCODE like CONCAT(#{item},'%')   
 		</foreach>  
		</if>
		<if test="timeVals!=null and timeVals.size() > 0">
 		AND 
			 q.DATE_FULL  IN
			<foreach item="item" index="index" collection="timeVals" open="(" separator="," close=")">
				#{item}
			</foreach>
			</if>
			</where>
	 	GROUP BY
       
		<include refid="queryRegionCodeLength"></include> ,
		
		round(USER_SUM / REGAREA, 2),
		REGCODE
		
		
		) x
		INNER JOIN dim_keyregion f ON x.zongjie = f.REGION_UCODE
		order by x.density DESC
	</select>
	
	<!-- ***********************END*/population/region*************************** -->
	
	<!-- ***********************population/realTime*************************** -->
	

		<!-- 通过粒度字段判断查询哪个表 -->
	<sql id="queryRealTimeTable">
		<choose>
	
	       <when test='timeSize.equals("1")'>
	              DM_PEOPLE_MIN
	       </when>
	       <when test='timeSize.equals("2")'>
	              
	              DM_REALPEOPLE_MIN
	       </when>
	      
	       <otherwise>
	              DM_PEOPLE_W
	       </otherwise>
		</choose>
	</sql>
	
	<!-- 拼接查询时间字段 -->
	<sql id="queryRealTimeField">
		<choose>
			<when test='timeSize.equals("1")'>
				  q.DATE_FULL     
	       </when>
	       <otherwise>
	               q.TIMEDESCRIBE
	       </otherwise>
		</choose>
	</sql>
	

	
	<select id="queryRealTime" resultType="hashMap">
SELECT
	x.userSum user_sum,
	x.inflowUserSum inflow_user_sum,
	x.outflowUserSum outflow_user_sum,
	x.fixUserSum fix_user_sum,
	f.REGION_NAME region_name,
	x.object_id,
	x.density density,
	x.reg_e reg_e,
	x.reg_n reg_n
	
FROM
	(
		SELECT
			<include refid="queryRegionCodeLength"></include>  zongjie,
			SUM(USER_SUM) userSum,
			round(USER_SUM /REGAREA,2) density,
			SUM(INFLOW_USER_SUM) inflowUserSum,
			SUM(OUTFLOW_USER_SUM) outflowUserSum,
			SUM(FIX_USER_SUM) fixUserSum,
			REGCODE object_id,
			REG_E reg_e,
			REG_N reg_n
			
		
		FROM
			<include refid="queryRealTimeTable"></include>  q
		<where> 
		

		<if test="regionType!=null and !regionType.equals('')">
		AND q.REGTYPE_ID = #{regionType}
		</if>
		
		
 	 	<if test="subRegionCode != null and subRegionCode.size() > 0">
		AND
		<foreach item="item" index="index" collection="subRegionCode" open="(" separator="OR" close=")">   
            q.REGUCODE like CONCAT(#{item},'%')   
 		</foreach>  
		</if>
		<if test="timeVals!=null and timeVals.size() > 0">
 		AND 
			<include refid="queryRealTimeField"></include>  IN
			<foreach item="item" index="index" collection="timeVals" open="(" separator="," close=")">
				#{item}
			</foreach>
			</if>
			</where>
	 	GROUP BY
		<include refid="queryRegionCodeLength"></include>,
		round(USER_SUM / REGAREA, 2),
		REG_E,REG_N,
		REGCODE 
		
		
		
		
		) x
		INNER JOIN dim_keyregion f ON x.zongjie = f.REGION_UCODE
		order by x.userSum DESC
	</select>
	
	
	
	<!-- ***********************END*/population/realTime*************************** -->

	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<!-- ************************/population/point**************************** -->
	<!-- 通过粒度字段判断查询哪个表 -->
	<sql id="queryPointTable">
		<choose>
			<when test='timeSize.equals("1")'>
	              pub_dw_user_rlpoint_h
	       </when>
	       <when test='timeSize.equals("2")'>
	              pub_dw_user_rlpoint_d
	       </when>
	       <when test='timeSize.equals("3")'>
	              pub_dw_user_rlpoint_w
	       </when>
	       <when test='timeSize.equals("4")'>
	              pub_dw_user_rlpoint_m
	       </when>
	       <when test='timeSize.equals("5")'>
	              pub_dw_user_rlpoint_q
	       </when>
	       <otherwise>
	              pub_dw_user_rlpoint_y
	       </otherwise>
		</choose>
	</sql>
	
	<!-- 拼接查询时间字段 -->
	<sql id="queryPointTimeField">
		<choose>
			<when test='timeSize.equals("1")'>
	              CONCAT(rp.date_d,rp.date_h)
	       </when>
	       <when test='timeSize.equals("2")'>
				  rp.date_d
	       </when>
	       <when test='timeSize.equals("3")'>
	              CONCAT(rp.date_m,rp.date_w)
	       </when>
	       <when test='timeSize.equals("4")'>
	              rp.date_m
	       </when>
	       <when test='timeSize.equals("5")'>
	              CONCAT(rp.date_m,rp.date_q)
	       </when>
	       <otherwise>
	              rp.date_y
	       </otherwise>
		</choose>
	</sql>
	
	<select id="queryPoint" resultType="hashMap">
		SELECT
			CONCAT(rp.LONGITUDE,',',rp.LATITUDE) loc,
			SUM(rp.FIX_USER_SUM) fixUserSum,
			SUM(rp.INFLOW_USER_SUM) inflowUserSum,
			SUM(rp.OUTFLOW_USER_SUM) outflowUserSum
		FROM
			<include refid="queryPointTable"></include> AS rp
			<where>
				<if test="homeCode != null">
				AND	rp.home_code LIKE CONCAT(#{homeCode},'%')  
				</if>
				<if test="workCode != null">
				AND	rp.work_code LIKE CONCAT(#{workCode},'%')  
				</if>	
				<if test="belongCode != null">
				AND	rp.belong_code LIKE CONCAT(#{belongCode},'%')  
				</if>				
				<if test="userType != null">
				AND	rp.user_type in
					<foreach item="item" index="index" collection="userType" open="(" separator="," close=")">
						#{item}
					</foreach>
				</if>
				
				<if test="true"><!-- 效率低，放在最后 -->
				AND
					<include refid="queryPointTimeField"></include> IN
					<foreach item="item" index="index" collection="timeVals" open="(" separator="," close=")">
						#{item}
					</foreach>
				</if>
			</where>
			
		GROUP BY
			loc
	</select>
	<!-- ***********************END*/population/point*************************** -->
</mapper>