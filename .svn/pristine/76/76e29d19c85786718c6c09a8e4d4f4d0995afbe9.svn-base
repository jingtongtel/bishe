<?xml version="1.0" encoding="UTF-8" ?>   
<!DOCTYPE mapper   
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boco.human.v01.mapper.TravelMapper">
	<!-- 排序SQL的嵌套头部 -->
	<sql id="orderSqlHead">
	SELECT
		@rownum :=@rownum + 1 orderRank,
		order_conent_outter.*
	FROM
		(
			SELECT
				@rownum := 0 no_use,
				order_conent_inner.*
			FROM
				(
	</sql>
	<!-- 排序SQL的嵌套尾部部 -->
	<sql id="orderSqlTail">
			) order_conent_inner
	) order_conent_outter
	</sql>

	<!-- 通过粒度字段判断查询哪个表 -->
	<sql id="queryTable">
		<choose>
			<when test='timeSize.equals("1")'>
	              pub_dw_user_od_h
	       </when>
	       <when test='timeSize.equals("2")'>
	              pub_dw_user_od_d
	       </when>
	       <when test='timeSize.equals("3")'>
	              pub_dw_user_od_w
	       </when>
	       <when test='timeSize.equals("4")'>
	              pub_dw_user_od_m
	       </when>
	       <when test='timeSize.equals("5")'>
	              pub_dw_user_od_q
	       </when>
	       <when test='timeSize.equals("6")'>
	              pub_dw_user_od_y
	       </when>
	       <otherwise>  <!-- 异常处理 -->
	              pub_dw_user_od_d
	       </otherwise>
		</choose>
	</sql>
	
	<!-- 拼接查询时间字段 -->
	<sql id="queryTimeField">
		<choose>
			<when test='timeSize.equals("1")'>
	              CONCAT(od.date_d,od.date_h)
	       </when>
	       <when test='timeSize.equals("2")'>
				  od.date_d
	       </when>
	       <otherwise>
	              od.date_d
	       </otherwise>
		</choose>
	</sql>
	<!-- 拼接查询时间字段 -->
	<sql id="queryTimeOField">
		<choose>
			<when test='timeSize.equals("1")'>
	              CONCAT(od.dateo_d,od.dateo_h)
	       </when>
	       <when test='timeSize.equals("2")'>
				  od.dateo_d
	       </when>
	       <otherwise>
	              od.dateo_d
	       </otherwise>
		</choose>
	</sql>
	<sql id="queryTimeDField">
		<choose>
			<when test='timeSize.equals("1")'>
	              CONCAT(od.dated_d,od.dated_h)
	       </when>
	       <when test='timeSize.equals("2")'>
				  od.dated_d
	       </when>
	       <otherwise>
	              od.dated_d
	       </otherwise>
		</choose>
	</sql>
	
	<!-- ********************根据需要显示字段的入参，在SQL中拼接相关字段、groupby、关联表************************** -->
	<sql id="showFieldsSelect">
		<if test="showFieldsSet != null and showFieldsSet.contains('odGoal')">
		 od_goal odGoal,
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odType')">
		 od_type odType,
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odTime')">
		 dateo_d odTime,
		</if>
		<!-- <if test="showFieldsSet != null and showFieldsSet.contains('odMode')">
		 od_mode odMode,
		</if> -->
	</sql>
	<sql id="showFieldsDict">
		<if test="showFieldsSet != null and showFieldsSet.contains('odGoal')">
		 dict_goal.dic_name	odGoal,
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odType')">
		 dict_type.dic_name	odType,
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odTime')">
		 od_value.odTime,
		</if>
		<!-- <if test="showFieldsSet != null and showFieldsSet.contains('odMode')">
		 dict_mode.dic_name	odModeName,
		</if> -->
	</sql>
	<sql id="showFieldsGroupBy">
		<if test="showFieldsSet != null and showFieldsSet.contains('odGoal')">
		 odGoal,
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odType')">
		 odType,
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odTime')">
		 odTime,
		</if>
		<!-- <if test="showFieldsSet != null and showFieldsSet.contains('odMode')">
		 odMode,
		</if> -->
	</sql>
	<sql id="showFieldsJion">
		<if test="showFieldsSet != null and showFieldsSet.contains('odGoal')">
		 pub_dim_datadictionary dict_goal,
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odType')">
		 pub_dim_datadictionary dict_type,
		</if>
		<!-- <if test="showFieldsSet != null and showFieldsSet.contains('odMode')">
		 pub_dim_datadictionary dict_mode,
		</if> -->
	</sql>
	<sql id="showFieldsJionWhere">
		<if test="showFieldsSet != null and showFieldsSet.contains('odGoal')">
		 AND dict_goal.dic_type='qycx-cxmd' 
		 AND dict_goal.dic_value = od_value.odGoal
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odType')">
		 AND dict_type.dic_type='qycx-cxfs' 
		 AND dict_type.dic_value = od_value.odGoal
		</if>
		<!-- <if test="showFieldsSet != null and showFieldsSet.contains('odMode')">
		 AND dict_mode.dic_type='qycx-cxmd' AND dict_goal.dic_value = od_value.odGoal
		</if> -->
	</sql>
	<!-- ************************************************************************************ -->
	
	<select id="intensity" resultType="hashMap">
		<if test="orderBy != null">
			<include refid="orderSqlHead"></include>
		</if>
		
		SELECT
			ro.REGION_NAME oName,   
			rd.REGION_NAME dName,
			<include refid="showFieldsDict"></include>
			odCnt / 100 val,		-- 出行强度的计算公式，此处为示例
			odCnt,
			od_value.distAvg,
			od_value.timeAvg,
			od_value.distSum,
			od_value.timeSum
		FROM
			pub_dim_keyregion ro,
			pub_dim_keyregion rd,
			<include refid="showFieldsJion"></include>
			(
				SELECT
					LEFT (                  -- 将目标数据的空间级别汇总为前台传入的级别
						od.O_REGION_CODE,
						${regionLevelLength}  
					) O_REGION_CODE_PRIX,
					LEFT (
						od.D_REGION_CODE,
						${regionLevelLength}
					) D_REGION_CODE_PRIX,
					<include refid="showFieldsSelect"></include>
					sum(od_cnt) odCnt,
					sum(od.od_dist_sum) / sum(od.od_cnt) distAvg,
					sum(od.od_times_sum) / sum(od.od_cnt) timeAvg,
					sum(od.od_dist_sum) distSum,
					sum(od.od_times_sum) timeSum
				FROM
					<include refid="queryTable"></include> AS od
				WHERE
					region_type=#{regionType}
				<if test="odDateD != null">
				AND  
					<foreach item="item" index="index" collection="odDateD" open="(" separator="OR" close=")">
						(<include refid="queryTimeOField"></include> = #{item} 
							and 
						 <include refid="queryTimeDField"></include> = #{item}
						 )
					</foreach>
				</if>
				<if test="odGoal != null">
				AND   od.od_goal = #{odGoal}
				</if>
				<if test="odType != null">
				AND   od.od_type = #{odType}
				</if>
				<if test='userType != null and  !userType.equals("0")'>
				AND  od.user_type = ${userType}
				</if>
				<!-- <if test="userType != null and  !userType.equals('0')">
				AND  od.user_type in
					<foreach item="item" index="index" collection="userType" open="(" separator="," close=")">
						#{item}
					</foreach>
				</if> -->
				
				<if test="subRegionCode != null and subRegionCode.size() > 0">
				AND
				(
					left(od.O_REGION_CODE,${regionLevelLength})  in
					<foreach item="item" index="index" collection="subRegionCode" open="(" separator="," close=")">
						  #{item}  
					</foreach>
					<choose>
						<!-- 只选择一个地区时，则筛选此区域和其他全部区域的od数据 --> 
						<when test="subRegionCode.size() == 1">
		                       OR
		                </when>
		                <otherwise>
		                       AND
		                </otherwise>
					</choose>
				
					left(od.D_REGION_CODE,${regionLevelLength})  in
					<foreach item="item" index="index" collection="subRegionCode" open="(" separator="," close=")">
						#{item}
					</foreach>
				)
				</if>
			GROUP BY
				<include refid="showFieldsGroupBy"></include>
				O_REGION_CODE_PRIX,
				D_REGION_CODE_PRIX
			) od_value
		WHERE
			ro.REGION_TYPE=#{regionType} AND od_value.O_REGION_CODE_PRIX = ro.REGION_CODE
		AND rd.REGION_TYPE=#{regionType} AND od_value.D_REGION_CODE_PRIX = rd.REGION_CODEa
		<include refid="showFieldsJionWhere"></include>
		<if test="orderBy != null">
			<include refid="orderSqlTail"></include>
			<if test="orderBy.size() > 0">
			ORDER BY 
				<foreach item="item" index="index" collection="orderBy" open="" separator="," close="">
					${item}
				</foreach>
			</if>
		</if>
		<if test="topN != null">
		LIMIT #{topN}
		</if>	
	</select>
	

</mapper>
