<?xml version="1.0" encoding="UTF-8" ?>   
<!DOCTYPE mapper   
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boco.human.v01.mapper.TravelMapper">
	<!-- 排序SQL的嵌套头部 -->
	<sql id="orderSqlHead">
		select *
			from (select row_.*, rownum order_rank
				from (
	</sql>
	<!-- 排序SQL的嵌套尾部部 -->
	<sql id="orderSqlTail">
		) row_)
		<choose>
			<when test="topN != null">
				where order_rank &lt;= #{topN}
			</when>
			<otherwise>  
			</otherwise>
		</choose>
	</sql>

	<!-- 通过粒度字段判断查询哪个表 -->
	<sql id="queryTable">
		<choose>
			<when test='timeSize.equals("1")'>
				dm_odcity_h
			</when>
			<when test='timeSize.equals("2")'>
				dm_odcity_d
			</when>
			<when test='timeSize.equals("3")'>
				dm_odcity_w
			</when>
			<when test='timeSize.equals("4")'>
				dm_odcity_m
			</when>
			<when test='timeSize.equals("5")'>
				dm_odcity_q
			</when>
			<when test='timeSize.equals("6")'>
				dm_odcity_y
			</when>
			<otherwise>  <!-- 异常处理 -->
				dm_odcity_d
			</otherwise>
		</choose>
	</sql>



	<!-- ********************根据需要显示字段的入参，在SQL中拼接相关字段、groupby、关联表************************** -->
	<sql id="showFieldsSelect">
		<if test="showFieldsSet != null and showFieldsSet.contains('odGoal')">
			od_aim od_goal,
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odType')">
			od_mode od_type,
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odTime')">
			date_full od_time,
		</if>
		<!-- <if test="showFieldsSet != null and showFieldsSet.contains('odMode')"> 
			od_mode odMode, </if> -->
	</sql>
	<sql id="showFieldsDict">
		<if test="showFieldsSet != null and showFieldsSet.contains('odGoal')">
			od_value.od_goal,
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odType')">
			od_value.od_type,
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odTime')">
			od_value.od_time,
		</if>
		<!-- <if test="showFieldsSet != null and showFieldsSet.contains('odMode')"> 
			dict_mode.dic_name odModeName, </if> -->
	</sql>
	<sql id="showFieldsGroupBy">
		<if test="showFieldsSet != null and showFieldsSet.contains('odGoal')">
			od_aim,
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odType')">
			od_mode,
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odTime')">
			date_full,
		</if>
		<!-- <if test="showFieldsSet != null and showFieldsSet.contains('odMode')"> 
			odMode, </if> -->
	</sql>
	<sql id="showFieldsJion">
		<if test="showFieldsSet != null and showFieldsSet.contains('odGoal')">
			dim_dictionary dict_goal,
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odType')">
			dim_dictionary dict_type,
		</if>
		<!-- <if test="showFieldsSet != null and showFieldsSet.contains('odMode')"> 
			pub_dim_datadictionary dict_mode, </if> -->
	</sql>
	<sql id="showFieldsJionWhere">
		<if test="showFieldsSet != null and showFieldsSet.contains('odGoal')">
			AND dict_goal.dic_type='cxmd'
			AND dict_goal.dic_value = od_value.odGoal
		</if>
		<if test="showFieldsSet != null and showFieldsSet.contains('odType')">
			AND dict_type.dic_type='cxfs'
			AND dict_type.dic_value = od_value.odGoal
		</if>
		<!-- <if test="showFieldsSet != null and showFieldsSet.contains('odMode')"> 
			AND dict_mode.dic_type='qycx-cxmd' AND dict_goal.dic_value = od_value.odGoal 
			</if> -->
	</sql>
	<!-- ************************************************************************************ -->

	<select id="intensity" resultType="hashMap">
		<if test="orderBy != null or topN != null">
			<include refid="orderSqlHead"></include>
		</if>

		SELECT
			ro.REGION_NAME o_name,
			ro.REGION_CODE o_object_id,
			rd.REGION_NAME d_name,
			rd.REGION_CODE d_object_id,
			<include refid="showFieldsDict"></include>
			od_cnt / 100 val, /* 出行强度的计算公式，此处为示例 */
			od_cnt,
			od_value.dist_avg,
			od_value.time_avg,
			od_value.dist_sum,
			od_value.time_sum
		FROM
			dim_keyregion ro,
			dim_keyregion rd,
			<!-- <include refid="showFieldsJion"></include> -->
		(
			SELECT
				substr(od.O_REGUCODE,1,${regionLevelLength}) O_REGION_CODE_PRIX,
				substr(od.D_REGUCODE,1,${regionLevelLength}) D_REGION_CODE_PRIX,
				<include refid="showFieldsSelect"></include>
				sum(od_cnt) od_cnt,
				sum(od.OD_DISTANCE) / sum(od.od_cnt) dist_avg,
				sum(od.OD_TIMES) / sum(od.od_cnt) time_avg,
				sum(od.OD_DISTANCE) dist_sum,
				sum(od.OD_TIMES) time_sum
			FROM
			<include refid="queryTable"></include> od
			WHERE
				o_regtype_id=#{regionType}
			<if test="odDateD != null">
				AND
				<foreach item="item" index="index" collection="odDateD" open="("
					separator="OR" close=")">
					(od.DATE_FULL = #{item}
					and
					od.DATE_FULL = #{item}
					)
				</foreach>
			</if>
			<if test="odGoal != null">
				AND od.od_aim_id = #{odGoal}
			</if>
			<if test="odType != null">
				AND od.od_mode_id = #{odType}
			</if>
			<if test='userType != null and  !userType.equals("0")'>
				AND od.user_type_id = #{userType}
			</if>
			
			<if test="subRegionCode != null and subRegionCode.size() > 0">
				AND
				(
				<foreach item="item" index="index" collection="subRegionCode" open="(" separator="OR" close=")">
					concat(od.O_REGUCODE,'-') LIKE concat(#{item},'-%') /* 取本身及子节点的数据 */
				</foreach>
				<choose>
					<!-- 只选择一个地区时，则筛选此区域和其他全部区域的od数据 -->
					<when test="subRegionCode.size() == 1">
						OR
					</when>
					<otherwise>
						AND
					</otherwise>
				</choose>
	
				<foreach item="item" index="index" collection="subRegionCode" open="(" separator="OR" close=")">
					concat(od.D_REGUCODE,'-') LIKE concat(#{item},'-%')
				</foreach>
				)
			</if>
			GROUP BY
				<include refid="showFieldsGroupBy"></include>
				substr(od.O_REGUCODE,1,${regionLevelLength}),
				substr(od.D_REGUCODE,1,${regionLevelLength})
		) od_value
		WHERE
			ro.REGION_TYPE_ID=#{regionType} AND od_value.O_REGION_CODE_PRIX = ro.REGION_UCODE
			AND
			rd.REGION_TYPE_ID=#{regionType} AND od_value.D_REGION_CODE_PRIX = rd.REGION_UCODE
		<!-- <include refid="showFieldsJionWhere"></include> -->
		<if test="orderBy != null and orderBy.size() > 0">
				ORDER BY
				<foreach item="item" index="index" collection="orderBy"
					open="" separator="," close="">
					${item}
				</foreach>
			</if>
		<if test="orderBy != null or topN != null">
			<include refid="orderSqlTail"></include>
		</if>
	</select>
</mapper>
